#! /bin/sh

COMMAND=`basename "$0"`

if [ "$1" = "-w" ]
then
	DIFF_OPTION=$1
	shift
fi

if [ "$*" = "" ]
then
	ARGS=`ls -v *.hs *.icl *.impl *.lnt *.lotos *.maude *.mcrl2 *.ml *.mod *.now *.rsc *.scala *.str *.t *.trs 2> /dev/null`
else
	ARGS=$*
fi

DIFF=`mktemp -t "rec_XXXXXXXXXX"`

for ARG in $ARGS
do
	case $ARG in
		*.hs )
			DIR=HASKELL ;;
		*.icl )
			DIR=CLEAN ;;
		*.impl )
			DIR=OPAL ;;
		*.lnt )
			DIR=LNT ;;
		*.lotos )
			DIR=LOTOS ;;
		*.maude )
			DIR=MAUDE ;;
		*.mcrl2 )
			DIR=MCRL2 ;;
		*.ml )
			DIR=OCAML ;;
		*.mod )
			# determine the CAFEOBJ version of the benchmark
			TAG=`head -n 1 "$ARG" | sed -e 's/^-- //'`
			case "$TAG" in
				"CAFEOBJ-A" ) DIR=CAFEOBJ-A ;;
				"CAFEOBJ-B" ) DIR=CAFEOBJ-B ;;
				* ) echo "$COMMAND: no CAFEOBJ tag found in $ARG"
			    	    exit 1
			esac
			;;
		*.now )
			DIR=SML ;;
		*.rsc )
			DIR=RASCAL ;;
		*.scala )
			DIR=SCALA ;;
		*.str )
			DIR=STRATEGO ;;
		*.t )
			# determine the TOM version of the benchmark
			TAG=`head -n 1 "$ARG" | sed -e 's+^// ++'`
			case "$TAG" in
				"TOM-A" ) DIR=TOM-A ;;
				"TOM-B" ) DIR=TOM-B ;;
				* ) echo "$COMMAND: no TOM tag found in $ARG"
			    	    exit 1
			esac
			;;
		*.trs )
			DIR=APROVE ;;
		* )
			echo "$COMMAND: unknown file type $ARG"
			exit 1
	esac
	if [ ! -f $DIR/$ARG ]
	then
		echo "installing $ARG in $DIR"
		mv -i $ARG $DIR
	else
		diff $DIFF_OPTION $DIR $ARG > $DIFF
		if [ -s $DIFF ]
		then
			echo "differences $ARG"
			echo ""
			cat $DIFF
			mv -i $ARG $DIR
		else
			rm $ARG
		fi
	fi
done

rm $DIFF

# specific cleanup for CADP

rm -f executor executor.o *.o
for FILE in `ls *.c *.h 2> /dev/null`
do
	grep "generated by caesar" $FILE > /dev/null && rm -f $FILE
done
rm -f LOTOS/*.c LOTOS/*.h LOTOS/*.o LOTOS/executor* 2> /dev/null

